<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="theme-color" content="#080808">
<title>Flow</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400&display=swap');

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root{
  --bg:#080808;--bg1:#0e0e0e;--bg2:#141414;--bg3:#1c1c1c;
  --line:#1e1e1e;--line2:#2a2a2a;--dim:#444;--muted:#666;--soft:#999;
  --text:#d8d8d8;--bright:#f0f0f0;
  --green:#39ff6e;--green2:rgba(57,255,110,0.09);--green3:rgba(57,255,110,0.04);
  --amber:#ffb638;--cyan:#38d9ff;--red:#ff4d4d;
  --mono:'JetBrains Mono',monospace;
  --safe-t:env(safe-area-inset-top,0px);
  --safe-b:env(safe-area-inset-bottom,0px);
}

html,body{height:100%;width:100%;background:var(--bg);color:var(--text);
  font-family:var(--mono);font-size:13px;overflow:hidden;
  -webkit-tap-highlight-color:transparent;user-select:none}

body::after{content:'';position:fixed;inset:0;z-index:9999;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.025) 2px,rgba(0,0,0,0.025) 4px)}

#app{display:flex;flex-direction:column;height:100dvh}

/* ── TOPBAR ── */
#topbar{
  display:flex;align-items:center;gap:10px;
  padding:0 14px;
  padding-top:max(12px,var(--safe-t));
  padding-bottom:10px;
  border-bottom:1px solid var(--line);
  flex-shrink:0;
}
.tb-logo{display:flex;align-items:center;gap:6px}
.tb-prompt{color:var(--green);font-weight:700;font-size:14px}
.tb-title{color:var(--bright);font-size:14px;font-weight:400;letter-spacing:.5px}
.tb-cursor{width:8px;height:14px;background:var(--green);display:inline-block;
  animation:blink 1.1s step-end infinite;vertical-align:middle;margin-left:1px}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}

#sync{margin-left:auto;display:flex;align-items:center;gap:5px}
.sync-dot{width:6px;height:6px;border-radius:50%;background:var(--dim);transition:background .3s;flex-shrink:0}
.sync-dot.syncing{background:var(--amber);animation:pulse .8s ease infinite}
.sync-dot.synced{background:var(--green)}
.sync-dot.error{background:var(--red)}
.sync-lbl{font-size:10px;color:var(--muted);letter-spacing:.3px}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

#cal-mode-btns{display:flex;gap:0;margin-left:8px}
.cm-btn{padding:4px 10px;font-size:10px;font-family:var(--mono);letter-spacing:.5px;
  background:none;border:1px solid var(--line2);color:var(--muted);cursor:pointer;transition:all .1s}
.cm-btn:first-child{border-radius:4px 0 0 4px}
.cm-btn:last-child{border-radius:0 4px 4px 0;border-left:none}
.cm-btn.active{background:var(--green2);border-color:var(--green);color:var(--green)}
#cal-mode-btns.hidden{display:none}

/* ── SWIPE CONTAINER ── */
#views-wrap{flex:1;display:flex;overflow:hidden;position:relative}
#views-track{display:flex;width:200%;height:100%;
  transition:transform .3s cubic-bezier(.4,0,.2,1);will-change:transform}
.view-pane{width:50%;height:100%;display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}

#view-dots{position:absolute;bottom:calc(72px + var(--safe-b));left:50%;transform:translateX(-50%);
  display:flex;gap:6px;z-index:20;pointer-events:none}
.vd{width:5px;height:5px;border-radius:50%;background:var(--dim);transition:background .2s,transform .2s}
.vd.active{background:var(--green);transform:scale(1.3)}

/* ── LIST VIEW ── */
#list-header{padding:10px 14px 8px;border-bottom:1px solid var(--line);
  display:flex;align-items:baseline;gap:8px;flex-shrink:0}
.lh-label{font-size:10px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase}
.lh-count{font-size:10px;color:var(--dim);margin-left:auto}

#list-scroll{flex:1;overflow-y:auto;padding:4px 10px 80px;overscroll-behavior:contain}
#list-scroll::-webkit-scrollbar{display:none}

.list-group-hdr{font-size:10px;color:var(--muted);letter-spacing:.8px;text-transform:uppercase;
  padding:12px 4px 5px;border-bottom:1px solid var(--line);margin-bottom:4px;
  display:flex;align-items:center;gap:8px}
.lgh-dot{width:5px;height:5px;border-radius:50%;background:var(--dim);flex-shrink:0}
.lgh-dot.today-dot{background:var(--green)}

.task-row{display:flex;align-items:flex-start;gap:9px;padding:9px 8px;border-radius:4px;
  cursor:pointer;border:1px solid transparent;transition:border-color .1s,background .1s;margin-bottom:2px}
.task-row:active{background:var(--bg2);border-color:var(--line2)}

.tr-check{flex-shrink:0;width:15px;height:15px;border:1px solid var(--dim);border-radius:2px;
  background:none;cursor:pointer;margin-top:1px;
  display:flex;align-items:center;justify-content:center;transition:all .1s}
.tr-check.done{border-color:var(--green);background:var(--green)}
.tr-check.done::after{content:'✓';font-size:9px;color:#080808;font-weight:700;line-height:1}

.tr-body{flex:1;min-width:0}
.tr-title{font-size:12px;color:var(--text);line-height:1.4;word-break:break-word}
.tr-title.done{text-decoration:line-through;color:var(--dim)}
.tr-meta{display:flex;gap:8px;margin-top:3px;flex-wrap:wrap;align-items:center}
.tr-time{font-size:10px;color:var(--cyan)}
.tr-dur{font-size:10px;color:var(--muted)}
.tr-subprog{font-size:10px;color:var(--amber)}
.tr-unsched{font-size:10px;color:var(--dim);font-style:italic}

.empty-list{display:flex;flex-direction:column;align-items:center;justify-content:center;
  flex:1;color:var(--dim);font-size:11px;line-height:2.2;padding:40px;text-align:center}
.el-prompt{color:var(--green)}

/* ── CAL VIEW ── */
#cal-nav{display:flex;align-items:center;padding:8px 12px;
  border-bottom:1px solid var(--line);flex-shrink:0;gap:8px}
.cn-btn{background:none;border:1px solid var(--line2);border-radius:3px;
  padding:4px 10px;color:var(--muted);cursor:pointer;
  font-size:12px;font-family:var(--mono);transition:all .1s}
.cn-btn:active{border-color:var(--green);color:var(--green)}
.cn-lbl{flex:1;text-align:center;font-size:11px;color:var(--soft);letter-spacing:.5px}
.cn-today{font-size:10px;color:var(--green);background:var(--green2);
  border:1px solid var(--green);border-radius:3px;
  padding:4px 8px;cursor:pointer;font-family:var(--mono);letter-spacing:.3px}

#cal-body{flex:1;overflow:hidden;display:flex;flex-direction:column}

/* DAY VIEW */
#day-view{flex:1;overflow-y:auto;overscroll-behavior:contain;padding-bottom:80px}
#day-view::-webkit-scrollbar{display:none}
.day-unscheduled{padding:8px 10px 4px;border-bottom:1px solid var(--line)}
.day-unscheduled-lbl{font-size:10px;color:var(--dim);letter-spacing:.5px;padding-bottom:5px}
.day-hour-row{display:flex;border-bottom:1px solid var(--line);min-height:50px}
.dhr-time{width:48px;flex-shrink:0;padding:7px 8px 0;font-size:10px;color:var(--dim);text-align:right}
.dhr-slot{flex:1;padding:4px 8px;min-height:50px}
.day-block{border-radius:3px;padding:6px 8px;margin-bottom:3px;cursor:pointer;
  border-left:2px solid var(--dim);background:var(--bg2);transition:background .1s}
.day-block:active{background:var(--bg3)}
.day-block.timed{border-left-color:var(--cyan)}
.day-block.done{opacity:.4}
.db-time{font-size:10px;color:var(--cyan);margin-bottom:2px}
.db-title{font-size:12px;color:var(--text)}
.db-title.done{text-decoration:line-through;color:var(--dim)}
.db-dur{font-size:10px;color:var(--muted);margin-top:1px}

/* WEEK VIEW */
#week-view{flex:1;overflow-y:auto;overscroll-behavior:contain;padding-bottom:80px}
#week-view::-webkit-scrollbar{display:none}
.wdb{border-bottom:1px solid var(--line)}
.wdb-hdr{display:flex;align-items:center;padding:7px 12px 6px;gap:10px;
  background:var(--bg1);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:10}
.wdb-name{font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase}
.wdb-num{font-size:16px;font-weight:500;color:var(--soft);line-height:1}
.wdb-num.today{color:var(--green)}
.wdb-cnt{font-size:10px;color:var(--dim);margin-left:auto}
.wdb-plus{font-size:14px;color:var(--dim);background:none;border:none;cursor:pointer;
  padding:2px 4px;font-family:var(--mono);transition:color .1s}
.wdb-plus:active{color:var(--green)}
.wdb-tasks{padding:4px 8px 6px;display:flex;flex-direction:column;gap:3px}
.wdb-empty{padding:10px 12px;font-size:10px;color:var(--line2);font-style:italic}

.cal-chip{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:3px;
  background:var(--bg2);border-left:2px solid var(--dim);cursor:pointer;transition:background .1s}
.cal-chip:active{background:var(--bg3)}
.cal-chip.timed{border-left-color:var(--cyan)}
.cal-chip.done{opacity:.4}
.cc-time{font-size:10px;color:var(--cyan);width:90px;flex-shrink:0;white-space:nowrap}
.cc-title{flex:1;font-size:12px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.cc-title.done{text-decoration:line-through;color:var(--dim)}
.cc-sub{font-size:10px;color:var(--amber);flex-shrink:0}
.cc-chk{flex-shrink:0;width:14px;height:14px;border:1px solid var(--dim);border-radius:2px;
  background:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s}
.cc-chk.done{border-color:var(--green);background:var(--green)}
.cc-chk.done::after{content:'✓';font-size:9px;color:#080808;font-weight:700;line-height:1}

/* MONTH VIEW */
#month-view{flex:1;overflow-y:auto;overscroll-behavior:contain;padding:6px 6px 0}
#month-view::-webkit-scrollbar{display:none}
.month-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.month-wday{text-align:center;padding:3px 0 5px;font-size:9px;color:var(--dim);letter-spacing:.8px;text-transform:uppercase}
.month-day{min-height:58px;border-radius:4px;border:1px solid transparent;
  padding:4px 3px;display:flex;flex-direction:column;cursor:pointer;transition:border-color .1s,background .1s}
.month-day:active{background:var(--bg2)}
.month-day.today{border-color:var(--green)}
.month-day.other{opacity:.3}
.month-day.selected{background:var(--green3);border-color:var(--line2)}
.md-num{font-size:11px;color:var(--muted);margin-bottom:2px}
.month-day.today .md-num{color:var(--green);font-weight:500}
.md-dots{display:flex;flex-direction:column;gap:1px}
.md-dot{font-size:9px;color:var(--soft);background:var(--bg2);border-radius:2px;
  padding:1px 3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.4}
.md-dot.timed{color:var(--cyan)}
.md-dot.done{color:var(--dim);text-decoration:line-through}
.md-more{font-size:9px;color:var(--dim);padding:1px 3px}

#month-day-panel{background:var(--bg1);border-top:1px solid var(--line2);
  overflow-y:auto;max-height:0;transition:max-height .2s;flex-shrink:0;padding-bottom:0}
#month-day-panel::-webkit-scrollbar{display:none}
#month-day-panel.open{max-height:180px}
.mdp-hdr{padding:8px 14px 4px;font-size:10px;color:var(--green);letter-spacing:.5px}
.mdp-row{display:flex;align-items:center;gap:10px;padding:8px 14px;
  border-bottom:1px solid var(--line);cursor:pointer}
.mdp-row:last-child{border-bottom:none}
.mdp-title{font-size:12px;flex:1}
.mdp-title.done{text-decoration:line-through;color:var(--dim)}
.mdp-time{font-size:10px;color:var(--cyan);white-space:nowrap}

/* ── SHEETS ── */
#overlay{position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.75);display:none}
#overlay.open{display:block}

#sheet{position:fixed;bottom:0;left:0;right:0;z-index:200;
  background:var(--bg1);border:1px solid var(--line2);border-bottom:none;
  border-radius:14px 14px 0 0;
  padding:16px 14px calc(16px + var(--safe-b));
  transform:translateY(100%);transition:transform .22s cubic-bezier(.32,.72,0,1);
  max-height:88dvh;overflow-y:auto}
#sheet::-webkit-scrollbar{display:none}
#sheet.open{transform:translateY(0)}

.sh-handle{width:32px;height:3px;background:var(--line2);border-radius:2px;margin:0 auto 16px}
.sh-cmd-row{font-size:11px;color:var(--green);margin-bottom:14px;letter-spacing:.5px}
.sh-cmd{color:var(--muted)}
.sh-field{margin-bottom:12px}
.sh-label{font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;display:block;margin-bottom:5px}
.sh-input{width:100%;background:var(--bg);border:1px solid var(--line2);border-radius:4px;
  padding:9px 10px;color:var(--bright);font-size:13px;font-family:var(--mono);
  outline:none;transition:border-color .1s}
.sh-input:focus{border-color:var(--green)}
.sh-input::placeholder{color:var(--dim);font-style:italic}
.sh-row2{display:flex;gap:8px}
.sh-row2 .sh-field{flex:1}
.sh-actions{display:flex;gap:8px;margin-top:6px}
.sh-submit{flex:1;padding:11px;background:var(--green);color:#080808;border:none;border-radius:4px;
  font-size:12px;font-weight:700;font-family:var(--mono);cursor:pointer;letter-spacing:.5px;transition:opacity .1s}
.sh-submit:active{opacity:.85}
.sh-cancel{padding:11px 16px;background:none;border:1px solid var(--line2);border-radius:4px;
  color:var(--muted);font-size:12px;font-family:var(--mono);cursor:pointer}

/* Detail */
#det-overlay{position:fixed;inset:0;z-index:250;background:rgba(0,0,0,.65);display:none}
#det-overlay.open{display:block}
#detail{position:fixed;bottom:0;left:0;right:0;z-index:300;
  background:var(--bg1);border:1px solid var(--line2);border-bottom:none;
  border-radius:14px 14px 0 0;
  padding:16px 14px calc(16px + var(--safe-b));
  transform:translateY(100%);transition:transform .22s cubic-bezier(.32,.72,0,1);
  max-height:82dvh;overflow-y:auto}
#detail::-webkit-scrollbar{display:none}
#detail.open{transform:translateY(0)}

.det-title{font-size:16px;font-weight:500;color:var(--bright);margin-bottom:10px}
.det-meta{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:16px}
.det-chip{font-size:10px;padding:3px 7px;border-radius:3px;
  border:1px solid var(--line2);color:var(--muted);font-family:var(--mono);letter-spacing:.3px}
.det-chip.date{color:var(--amber);border-color:var(--amber)}
.det-chip.time{color:var(--cyan);border-color:var(--cyan)}
.det-chip.nodate{color:var(--green);border-color:var(--green)}
.det-sec{font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:8px}
.det-subs{display:flex;flex-direction:column;gap:4px;margin-bottom:12px}
.det-sub{display:flex;align-items:center;gap:8px;padding:8px 10px;
  background:var(--bg);border:1px solid var(--line);border-radius:4px}
.det-sub-title{flex:1;font-size:12px;color:var(--text)}
.det-sub-title.done{text-decoration:line-through;color:var(--dim)}
.det-sub-del{background:none;border:none;cursor:pointer;color:var(--line2);font-size:14px;padding:0 2px;transition:color .1s}
.det-sub-del:active{color:var(--red)}
.det-add-row{display:flex;gap:6px;margin-bottom:16px}
.det-add-inp{flex:1;background:var(--bg);border:1px solid var(--line2);border-radius:4px;
  padding:8px 10px;color:var(--bright);font-size:12px;font-family:var(--mono);outline:none}
.det-add-inp:focus{border-color:var(--green)}
.det-add-inp::placeholder{color:var(--dim);font-style:italic}
.det-add-btn{padding:8px 12px;background:var(--green2);border:1px solid var(--green);
  border-radius:4px;color:var(--green);font-size:11px;font-family:var(--mono);cursor:pointer}
.det-actions{display:flex;gap:8px}
.det-del{padding:10px 14px;background:none;border:1px solid var(--red);border-radius:4px;color:var(--red);font-size:11px;font-family:var(--mono);cursor:pointer}
.det-edit{padding:10px 14px;background:none;border:1px solid var(--amber);border-radius:4px;color:var(--amber);font-size:11px;font-family:var(--mono);cursor:pointer}
.det-close{flex:1;padding:10px;background:var(--bg2);border:1px solid var(--line2);border-radius:4px;color:var(--text);font-size:12px;font-family:var(--mono);cursor:pointer}

/* FAB */
#fab{position:fixed;bottom:calc(18px + var(--safe-b));right:16px;z-index:50;
  width:48px;height:48px;border-radius:4px;background:var(--green);color:#080808;
  border:none;cursor:pointer;font-size:22px;font-weight:300;font-family:var(--mono);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 28px rgba(57,255,110,.28);transition:transform .15s,box-shadow .15s}
#fab:active{transform:scale(.93)}
#fab.open{transform:rotate(45deg)}

/* SETUP */
#setup{position:fixed;inset:0;z-index:500;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:32px 24px;font-family:var(--mono)}
#setup.hidden{display:none}
.su-prompt{color:var(--green);font-size:12px;margin-bottom:6px}
.su-title{color:var(--bright);font-size:18px;font-weight:500;margin-bottom:8px}
.su-desc{color:var(--muted);font-size:11px;line-height:1.8;margin-bottom:24px;text-align:center;max-width:300px}
.su-lbl{font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;
  align-self:flex-start;margin-bottom:5px;width:100%;max-width:320px;margin-top:8px}
.su-inp{width:100%;max-width:320px;background:var(--bg1);border:1px solid var(--line2);border-radius:4px;
  padding:11px 12px;color:var(--bright);font-size:13px;font-family:var(--mono);outline:none;transition:border-color .1s}
.su-inp:focus{border-color:var(--green)}
.su-inp::placeholder{color:var(--dim)}
.su-btn{width:100%;max-width:320px;padding:12px;background:var(--green);color:#080808;
  border:none;border-radius:4px;font-size:13px;font-weight:700;font-family:var(--mono);cursor:pointer;margin-top:14px}
.su-note{font-size:10px;color:var(--dim);margin-top:16px;text-align:center;max-width:300px;line-height:1.7}
.su-note a{color:var(--amber);text-decoration:none}
</style>
</head>
<body>

<div id="setup">
  <div class="su-prompt">$ flow --configure</div>
  <div class="su-title">connect to vercel</div>
  <div class="su-desc">Enter your deployed URL and the <code style="color:var(--amber)">FLOW_API_KEY</code> set in Vercel environment variables.</div>
  <div class="su-lbl">app url</div>
  <input class="su-inp" id="su-url" placeholder="https://your-app.vercel.app" autocapitalize="none" autocomplete="off">
  <div class="su-lbl">api key</div>
  <input class="su-inp" id="su-key" type="password" placeholder="your-secret-key">
  <button class="su-btn" id="su-save">→ connect</button>
  <div class="su-note">Stored in browser localStorage only.<br>
    <a href="https://vercel.com/docs/storage/vercel-kv" target="_blank">Vercel KV setup guide ↗</a>
  </div>
</div>

<div id="app">
  <div id="topbar">
    <div class="tb-logo">
      <span class="tb-prompt">$</span>
      <span class="tb-title">flow</span>
      <span class="tb-cursor"></span>
    </div>
    <div id="sync">
      <div class="sync-dot" id="sync-dot"></div>
      <span class="sync-lbl" id="sync-lbl">--</span>
    </div>
    <div id="cal-mode-btns" class="hidden">
      <button class="cm-btn active" data-cm="day">day</button>
      <button class="cm-btn" data-cm="week">week</button>
      <button class="cm-btn" data-cm="month">month</button>
    </div>
  </div>

  <div id="views-wrap">
    <div id="views-track">

      <!-- LIST PANE -->
      <div class="view-pane" id="pane-list">
        <div id="list-header">
          <span class="lh-label">list</span>
          <span class="lh-count" id="list-count">0</span>
        </div>
        <div id="list-scroll"></div>
      </div>

      <!-- CAL PANE -->
      <div class="view-pane" id="pane-cal">
        <div id="cal-nav">
          <button class="cn-btn" id="cal-prev">‹</button>
          <div class="cn-lbl" id="cal-lbl"></div>
          <button class="cn-btn" id="cal-next">›</button>
          <button class="cn-today" id="cal-today">today</button>
        </div>
        <div id="cal-body">
          <div id="day-view"></div>
          <div id="week-view" style="display:none"></div>
          <div id="month-view" style="display:none"></div>
          <div id="month-day-panel"></div>
        </div>
      </div>

    </div>
    <div id="view-dots">
      <div class="vd active"></div>
      <div class="vd"></div>
    </div>
  </div>
</div>

<button id="fab">+</button>

<div id="overlay"></div>
<div id="sheet">
  <div class="sh-handle"></div>
  <div class="sh-cmd-row"><span class="sh-cmd">task.create</span>({ }</div>
  <div class="sh-field">
    <label class="sh-label">title</label>
    <input class="sh-input" id="inp-title" placeholder="What needs to happen?" autocomplete="off">
  </div>
  <div class="sh-row2" style="margin-bottom:12px">
    <div class="sh-field" style="margin-bottom:0">
      <label class="sh-label">date</label>
      <input class="sh-input" id="inp-date" type="date">
    </div>
  </div>
  <div class="sh-row2">
    <div class="sh-field">
      <label class="sh-label">start time</label>
      <input class="sh-input" id="inp-start" type="time">
    </div>
    <div class="sh-field">
      <label class="sh-label">end time</label>
      <input class="sh-input" id="inp-end" type="time">
    </div>
  </div>
  <div class="sh-actions">
    <button class="sh-cancel" id="sh-cancel">esc</button>
    <button class="sh-submit" id="sh-submit">→ add</button>
  </div>
</div>

<div id="det-overlay"></div>
<div id="detail">
  <div class="sh-handle"></div>
  <div class="det-title" id="det-title"></div>
  <div class="det-meta" id="det-meta"></div>
  <div class="det-sec">subtasks</div>
  <div class="det-subs" id="det-subs"></div>
  <div class="det-add-row">
    <input class="det-add-inp" id="det-sub-inp" placeholder="+ subtask">
    <button class="det-add-btn" id="det-sub-btn">add</button>
  </div>
  <div class="det-actions">
    <button class="det-del" id="det-del">rm</button>
    <button class="det-edit" id="det-edit">edit</button>
    <button class="det-close" id="det-close">done</button>
  </div>
</div>

<script>
const $=id=>document.getElementById(id);
const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

// ── CONFIG ──
let CFG=JSON.parse(localStorage.getItem('flow_cfg')||'null');
function showSetup(){$('setup').classList.remove('hidden')}
function hideSetup(){$('setup').classList.add('hidden')}
$('su-save').addEventListener('click',()=>{
  let url=$('su-url').value.trim().replace(/\/$/,'');
  const key=$('su-key').value.trim();
  if(!url||!key)return;
  if(!url.startsWith('http'))url='https://'+url;
  CFG={url,key};localStorage.setItem('flow_cfg',JSON.stringify(CFG));
  hideSetup();loadTasks();
});

// ── SYNC ──
let tasks=[],syncTimer=null;
function setSyncState(s,l){$('sync-dot').className='sync-dot '+s;$('sync-lbl').textContent=l}
async function loadTasks(){
  if(!CFG)return;setSyncState('syncing','loading');
  try{
    const r=await fetch(`${CFG.url}/api/tasks`,{headers:{'x-api-key':CFG.key}});
    if(!r.ok)throw Error(r.status);
    tasks=(await r.json()).tasks||[];
    localStorage.setItem('flow_cache',JSON.stringify(tasks));
    setSyncState('synced','synced');render();
  }catch(e){
    setSyncState('error','offline');
    const c=localStorage.getItem('flow_cache');
    if(c){tasks=JSON.parse(c);render();}
  }
}
function saveTasks(){
  localStorage.setItem('flow_cache',JSON.stringify(tasks));
  if(!CFG)return;
  setSyncState('syncing','saving');clearTimeout(syncTimer);
  syncTimer=setTimeout(async()=>{
    try{
      const r=await fetch(`${CFG.url}/api/tasks`,{method:'POST',
        headers:{'content-type':'application/json','x-api-key':CFG.key},
        body:JSON.stringify({tasks})});
      if(!r.ok)throw Error(r.status);setSyncState('synced','synced');
    }catch(e){setSyncState('error','sync err');}
  },600);
}

// ── STATE ──
const TODAY=new Date();TODAY.setHours(0,0,0,0);
let currentPane=0,calMode='day',calOffset=0,selectedMonthDay=null,openDetailId=null;

const DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
const MS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

function dateKey(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function todayKey(){return dateKey(TODAY)}
function parseDate(s){if(!s)return null;const[y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d)}
function fmt12(t){if(!t)return'';const[h,m]=t.split(':').map(Number);return`${h%12||12}:${String(m).padStart(2,'0')}${h>=12?'p':'a'}`}
function fmtRange(s,e){if(!s)return'';return e?`${fmt12(s)}–${fmt12(e)}`:fmt12(s)}
function durMins(s,e){if(!s||!e)return null;const[sh,sm]=s.split(':').map(Number),[eh,em]=e.split(':').map(Number);return(eh*60+em)-(sh*60+sm)}
function fmtDur(m){if(!m||m<=0)return'';const h=Math.floor(m/60),r=m%60;return r?`${h?h+'h':''}${r}m`:`${h}h`}
function taskSortKey(t){return t.date?(t.date+'_'+(t.startTime||'23:59')):('z_'+t.title.toLowerCase())}

// ── LIST ──
function renderList(){
  const scroll=$('list-scroll'),cnt=$('list-count');
  cnt.textContent=`${tasks.filter(t=>!t.done).length} pending`;
  if(!tasks.length){scroll.innerHTML=`<div class="empty-list"><span class="el-prompt">$</span> no tasks yet<br><span style="color:var(--dim)">tap + to create</span></div>`;return;}
  const sorted=[...tasks].sort((a,b)=>{
    if(a.done!==b.done)return a.done?1:-1;
    const ka=taskSortKey(a),kb=taskSortKey(b);return ka<kb?-1:ka>kb?1:0;
  });
  const groups=[];let lastKey=null;
  sorted.forEach(t=>{const gk=t.date||'__z';if(gk!==lastKey){groups.push({key:gk,tasks:[]});lastKey=gk;}groups[groups.length-1].tasks.push(t);});
  let html='';
  groups.forEach(g=>{
    const isToday=g.key===todayKey(),isU=g.key==='__z';
    let lbl;
    if(isU)lbl='unscheduled';
    else{const d=parseDate(g.key);lbl=`${DAYS[d.getDay()].toUpperCase()}, ${MS[d.getMonth()]} ${d.getDate()}${isToday?' · TODAY':''}`;}
    html+=`<div class="list-group-hdr"><span class="lgh-dot ${isToday?'today-dot':''}"></span>${lbl}</div>`;
    g.tasks.forEach(t=>{
      const sub=t.subtasks||[],sd=sub.filter(s=>s.done).length,dur=durMins(t.startTime,t.endTime);
      html+=`<div class="task-row" data-open="${t.id}">
        <button class="tr-check ${t.done?'done':''}" data-check="${t.id}"></button>
        <div class="tr-body">
          <div class="tr-title ${t.done?'done':''}">${esc(t.title)}</div>
          <div class="tr-meta">
            ${t.startTime?`<span class="tr-time">${fmtRange(t.startTime,t.endTime)}</span>`:''}
            ${dur?`<span class="tr-dur">${fmtDur(dur)}</span>`:''}
            ${sub.length?`<span class="tr-subprog">${sd}/${sub.length}</span>`:''}
            ${!t.date?`<span class="tr-unsched">no date</span>`:''}
          </div>
        </div>
      </div>`;
    });
  });
  scroll.innerHTML=html;
}

// ── CAL HELPERS ──
function focusDate(){
  const d=new Date(TODAY);
  if(calMode==='day')d.setDate(TODAY.getDate()+calOffset);
  else if(calMode==='week')d.setDate(TODAY.getDate()+calOffset*7);
  else d.setMonth(TODAY.getMonth()+calOffset);
  return d;
}
function updateCalLabel(){
  const d=focusDate(),lbl=$('cal-lbl');
  if(calMode==='day'){const dk=dateKey(d);lbl.textContent=`${DAYS[d.getDay()]}, ${MS[d.getMonth()]} ${d.getDate()}${dk===todayKey()?' · today':''}`;}
  else if(calMode==='week'){
    const dow=d.getDay(),s=new Date(d);s.setDate(d.getDate()-dow);
    const e=new Date(s);e.setDate(s.getDate()+6);
    lbl.textContent=`${MS[s.getMonth()]} ${s.getDate()} – ${s.getMonth()!==e.getMonth()?MS[e.getMonth()]+' ':''}${e.getDate()}`;
  }else{lbl.textContent=`${MONTHS[d.getMonth()]} ${d.getFullYear()}`;}
}
function tmap(){
  const m={};
  tasks.forEach(t=>{if(!t.date)return;if(!m[t.date])m[t.date]=[];m[t.date].push(t);});
  Object.values(m).forEach(a=>a.sort((a,b)=>(!a.startTime&&!b.startTime)?0:!a.startTime?1:!b.startTime?-1:a.startTime.localeCompare(b.startTime)));
  return m;
}

// ── DAY VIEW ──
function renderDay(){
  const view=$('day-view'),d=focusDate(),dk=dateKey(d);
  const dayT=tasks.filter(t=>t.date===dk).sort((a,b)=>(!a.startTime&&!b.startTime)?0:!a.startTime?1:!b.startTime?-1:a.startTime.localeCompare(b.startTime));
  const untimed=dayT.filter(t=>!t.startTime),timed=dayT.filter(t=>t.startTime);
  let html='';
  if(untimed.length){
    html+=`<div class="day-unscheduled"><div class="day-unscheduled-lbl">UNSCHEDULED</div>`;
    untimed.forEach(t=>{
      const sub=t.subtasks||[],sd=sub.filter(s=>s.done).length;
      html+=`<div class="day-block ${t.done?'done':''}" data-open="${t.id}">
        <div class="db-title ${t.done?'done':''}">${esc(t.title)}</div>
        ${sub.length?`<div class="db-dur">${sd}/${sub.length} subtasks</div>`:''}
      </div>`;
    });
    html+=`</div>`;
  }
  const hoursSet=new Set([7,8,9,10,11,12,13,14,15,16,17,18,19,20,21]);
  timed.forEach(t=>hoursSet.add(parseInt(t.startTime.split(':')[0])));
  [...hoursSet].sort((a,b)=>a-b).forEach(h=>{
    const ht=timed.filter(t=>parseInt(t.startTime.split(':')[0])===h);
    html+=`<div class="day-hour-row"><div class="dhr-time">${fmt12(String(h).padStart(2,'0')+':00')}</div><div class="dhr-slot">`;
    ht.forEach(t=>{
      const dur=durMins(t.startTime,t.endTime),sub=t.subtasks||[],sd=sub.filter(s=>s.done).length;
      html+=`<div class="day-block timed ${t.done?'done':''}" data-open="${t.id}">
        <div class="db-time">${fmtRange(t.startTime,t.endTime)}${dur?` · ${fmtDur(dur)}`:''}</div>
        <div class="db-title ${t.done?'done':''}">${esc(t.title)}</div>
        ${sub.length?`<div class="db-dur">${sd}/${sub.length} subtasks</div>`:''}
      </div>`;
    });
    html+=`</div></div>`;
  });
  if(!dayT.length)html=`<div style="padding:48px;text-align:center;font-size:11px;color:var(--line2)">— nothing here —</div>`;
  view.innerHTML=html;
}

// ── WEEK VIEW ──
function renderWeek(){
  const view=$('week-view'),d=focusDate(),dow=d.getDay(),ws=new Date(d);ws.setDate(d.getDate()-dow);
  const tm=tmap();let html='';
  for(let i=0;i<7;i++){
    const day=new Date(ws);day.setDate(ws.getDate()+i);
    const dk=dateKey(day),isToday=dk===todayKey(),dt=tm[dk]||[];
    const pending=dt.filter(t=>!t.done).length;
    const chips=dt.length?dt.map(t=>{
      const sub=t.subtasks||[],sd=sub.filter(s=>s.done).length;
      return`<div class="cal-chip ${t.startTime?'timed':''} ${t.done?'done':''}" data-open="${t.id}">
        <span class="cc-time">${fmtRange(t.startTime,t.endTime)}</span>
        <span class="cc-title ${t.done?'done':''}">${esc(t.title)}</span>
        ${sub.length?`<span class="cc-sub">${sd}/${sub.length}</span>`:''}
        <button class="cc-chk ${t.done?'done':''}" data-check="${t.id}"></button>
      </div>`;}).join(''):`<div class="wdb-empty">—</div>`;
    html+=`<div class="wdb"><div class="wdb-hdr">
      <span class="wdb-name">${DAYS[day.getDay()].toUpperCase()}</span>
      <span class="wdb-num ${isToday?'today':''}">${day.getDate()}</span>
      ${pending?`<span class="wdb-cnt">${pending}</span>`:''}
      <button class="wdb-plus" data-day-fab="${dk}">+</button>
    </div><div class="wdb-tasks">${chips}</div></div>`;
  }
  view.innerHTML=html;
}

// ── MONTH VIEW ──
function renderMonth(){
  const view=$('month-view'),d=focusDate(),y=d.getFullYear(),mo=d.getMonth();
  const firstDow=new Date(y,mo,1).getDay(),dim=new Date(y,mo+1,0).getDate();
  const tm=tmap();
  let html=`<div class="month-grid">`;
  ['S','M','T','W','T','F','S'].forEach(n=>html+=`<div class="month-wday">${n}</div>`);
  const cells=Math.ceil((firstDow+dim)/7)*7;
  for(let i=0;i<cells;i++){
    const dn=i-firstDow+1,day=new Date(y,mo,dn),dk=dateKey(day);
    const isOther=day.getMonth()!==mo,isToday=dk===todayKey(),isSel=dk===selectedMonthDay;
    const dt=tm[dk]||[];
    const dots=dt.slice(0,3).map(t=>`<div class="md-dot ${t.startTime?'timed':''} ${t.done?'done':''}">${t.title}</div>`).join('');
    html+=`<div class="month-day ${isToday?'today':''} ${isOther?'other':''} ${isSel?'selected':''}" data-mday="${dk}">
      <div class="md-num">${day.getDate()}</div>
      <div class="md-dots">${dots}${dt.length>3?`<div class="md-more">+${dt.length-3}</div>`:''}</div>
    </div>`;
  }
  html+=`</div>`;view.innerHTML=html;
  renderMonthPanel();
}
function renderMonthPanel(){
  const panel=$('month-day-panel');
  if(!selectedMonthDay){panel.className='';panel.innerHTML='';return;}
  const dt=tasks.filter(t=>t.date===selectedMonthDay).sort((a,b)=>(!a.startTime&&!b.startTime)?0:!a.startTime?1:!b.startTime?-1:a.startTime.localeCompare(b.startTime));
  if(!dt.length){panel.className='';panel.innerHTML='';return;}
  panel.className='open';
  panel.innerHTML=`<div class="mdp-hdr">${selectedMonthDay}</div>`+
    dt.map(t=>`<div class="mdp-row" data-open="${t.id}">
      <button class="tr-check ${t.done?'done':''}" data-check="${t.id}"></button>
      <span class="mdp-title ${t.done?'done':''}">${esc(t.title)}</span>
      ${t.startTime?`<span class="mdp-time">${fmtRange(t.startTime,t.endTime)}</span>`:''}
    </div>`).join('');
}

// ── RENDER ──
function renderCal(){
  updateCalLabel();
  $('day-view').style.display=calMode==='day'?'':'none';
  $('week-view').style.display=calMode==='week'?'':'none';
  $('month-view').style.display=calMode==='month'?'':'none';
  if(calMode==='day')renderDay();
  else if(calMode==='week')renderWeek();
  else renderMonth();
}
function render(){renderList();if(currentPane===1)renderCal();}

// ── SWIPE ──
function goPane(idx,animate=true){
  currentPane=idx;
  const t=$('views-track');
  t.style.transition=animate?'transform .3s cubic-bezier(.4,0,.2,1)':'none';
  t.style.transform=`translateX(${-idx*50}%)`;
  document.querySelectorAll('.vd').forEach((d,i)=>d.classList.toggle('active',i===idx));
  $('cal-mode-btns').classList.toggle('hidden',idx!==1);
  if(idx===1)renderCal();
}

let tx=null,ty=null;
$('views-wrap').addEventListener('touchstart',e=>{tx=e.touches[0].clientX;ty=e.touches[0].clientY;},{passive:true});
$('views-wrap').addEventListener('touchend',e=>{
  if(tx===null)return;
  const dx=e.changedTouches[0].clientX-tx,dy=e.changedTouches[0].clientY-ty;
  if(Math.abs(dx)>Math.abs(dy)&&Math.abs(dx)>44){
    if(dx<0&&currentPane===0)goPane(1);
    else if(dx>0&&currentPane===1)goPane(0);
  }
  tx=null;ty=null;
},{passive:true});

// ── DETAIL ──
function openDetail(id){
  const t=tasks.find(t=>t.id===id);if(!t)return;
  openDetailId=id;
  $('det-title').textContent=t.title;
  const meta=$('det-meta');meta.innerHTML='';
  if(!t.date)meta.innerHTML+=`<span class="det-chip nodate">unscheduled</span>`;
  if(t.date) meta.innerHTML+=`<span class="det-chip date">${t.date}</span>`;
  if(t.startTime)meta.innerHTML+=`<span class="det-chip time">${fmtRange(t.startTime,t.endTime)}</span>`;
  const dur=durMins(t.startTime,t.endTime);
  if(dur)meta.innerHTML+=`<span class="det-chip">${fmtDur(dur)}</span>`;
  renderDetSubs(t);
  $('det-sub-inp').value='';
  $('det-overlay').classList.add('open');$('detail').classList.add('open');
}
function renderDetSubs(t){
  const c=$('det-subs'),subs=t.subtasks||[];
  if(!subs.length){c.innerHTML=`<div style="font-size:11px;color:var(--dim);font-style:italic;padding:4px 0">no subtasks</div>`;return;}
  c.innerHTML=subs.map(s=>`<div class="det-sub">
    <button class="tr-check ${s.done?'done':''}" data-subcheck="${t.id}" data-subid="${s.id}"></button>
    <span class="det-sub-title ${s.done?'done':''}">${esc(s.title)}</span>
    <button class="det-sub-del" data-subdel="${t.id}" data-subid="${s.id}">×</button>
  </div>`).join('');
}
function closeDetail(){$('det-overlay').classList.remove('open');$('detail').classList.remove('open');openDetailId=null;render();}

// ── ADD/EDIT SHEET ──
function openSheet(opts={}){
  $('inp-title').value=opts.title||'';
  $('inp-date').value=opts.date||'';
  $('inp-start').value=opts.startTime||'';
  $('inp-end').value=opts.endTime||'';
  const btn=$('sh-submit');
  btn.textContent=opts.editId?'→ update':'→ add';
  if(opts.editId)btn.dataset.editId=opts.editId;else delete btn.dataset.editId;
  $('overlay').classList.add('open');$('sheet').classList.add('open');$('fab').classList.add('open');
  setTimeout(()=>$('inp-title').focus(),100);
}
function closeSheet(){
  $('overlay').classList.remove('open');$('sheet').classList.remove('open');$('fab').classList.remove('open');
  ['inp-title','inp-date','inp-start','inp-end'].forEach(id=>$(id).value='');
  const btn=$('sh-submit');btn.textContent='→ add';delete btn.dataset.editId;
}
function submitTask(){
  const title=$('inp-title').value.trim();if(!title)return;
  const date=$('inp-date').value||null;
  const startTime=$('inp-start').value||null;
  const endTime=$('inp-end').value||null;
  const editId=$('sh-submit').dataset.editId;
  if(editId){
    const t=tasks.find(t=>String(t.id)===editId);
    if(t){t.title=title;t.date=date;t.startTime=startTime;t.endTime=endTime;}
  }else{
    tasks.push({id:Date.now()+Math.random(),title,date,startTime,endTime,done:false,subtasks:[]});
  }
  saveTasks();closeSheet();render();
}

// ── EVENTS ──
document.addEventListener('click',e=>{
  const cm=e.target.closest('.cm-btn');
  if(cm){calMode=cm.dataset.cm;calOffset=0;selectedMonthDay=null;
    document.querySelectorAll('.cm-btn').forEach(b=>b.classList.toggle('active',b.dataset.cm===calMode));
    renderCal();return;}

  if(e.target.id==='fab'){$('sheet').classList.contains('open')?closeSheet():openSheet();return;}

  const dayFab=e.target.closest('[data-day-fab]');
  if(dayFab){e.stopPropagation();openSheet({date:dayFab.dataset.dayFab});return;}

  if(e.target.id==='overlay'){closeSheet();return;}
  if(e.target.id==='sh-cancel'){closeSheet();return;}
  if(e.target.id==='sh-submit'){submitTask();return;}

  if(e.target.id==='det-overlay'){closeDetail();return;}
  if(e.target.id==='det-close'){closeDetail();return;}
  if(e.target.id==='det-del'){if(openDetailId){tasks=tasks.filter(t=>t.id!==openDetailId);saveTasks();closeDetail();}return;}
  if(e.target.id==='det-edit'){
    const t=tasks.find(t=>t.id===openDetailId);if(!t)return;
    closeDetail();
    setTimeout(()=>openSheet({title:t.title,date:t.date||'',startTime:t.startTime||'',endTime:t.endTime||'',editId:String(t.id)}),220);
    return;
  }

  if(e.target.id==='det-sub-btn'){
    const val=$('det-sub-inp').value.trim();if(!val||!openDetailId)return;
    const t=tasks.find(t=>t.id===openDetailId);
    if(t){t.subtasks.push({id:Date.now()+Math.random(),title:val,done:false});$('det-sub-inp').value='';saveTasks();renderDetSubs(t);}return;
  }

  const sdel=e.target.closest('[data-subdel]');
  if(sdel){const tid=parseFloat(sdel.dataset.subdel),sid=parseFloat(sdel.dataset.subid);
    const t=tasks.find(t=>t.id===tid);
    if(t){t.subtasks=t.subtasks.filter(s=>s.id!==sid);saveTasks();renderDetSubs(t);}return;}

  const dsc=e.target.closest('#detail [data-subcheck]');
  if(dsc){const tid=parseFloat(dsc.dataset.subcheck),sid=parseFloat(dsc.dataset.subid);
    const t=tasks.find(t=>t.id===tid);
    if(t){const s=t.subtasks.find(s=>s.id===sid);if(s){s.done=!s.done;saveTasks();renderDetSubs(t);}}return;}

  const chk=e.target.closest('[data-check]');
  if(chk&&!e.target.closest('#detail')){e.stopPropagation();
    const id=parseFloat(chk.dataset.check),t=tasks.find(t=>t.id===id);
    if(t){t.done=!t.done;saveTasks();render();}return;}

  const openEl=e.target.closest('[data-open]');
  if(openEl&&!e.target.closest('[data-check]')){openDetail(parseFloat(openEl.dataset.open));return;}

  if(e.target.id==='cal-prev'){calOffset--;selectedMonthDay=null;renderCal();return;}
  if(e.target.id==='cal-next'){calOffset++;selectedMonthDay=null;renderCal();return;}
  if(e.target.id==='cal-today'){calOffset=0;selectedMonthDay=null;renderCal();return;}

  const mday=e.target.closest('[data-mday]');
  if(mday&&!e.target.closest('[data-open]')&&!e.target.closest('[data-check]')){
    const dk=mday.dataset.mday;selectedMonthDay=selectedMonthDay===dk?null:dk;renderMonth();return;}
});

$('sync-dot').addEventListener('dblclick',()=>showSetup());
$('inp-title').addEventListener('keydown',e=>{if(e.key==='Enter')submitTask();});
$('det-sub-inp').addEventListener('keydown',e=>{if(e.key==='Enter')$('det-sub-btn').click();});

// ── INIT ──
goPane(0,false);
if(!CFG){showSetup();}
else{
  hideSetup();
  const c=localStorage.getItem('flow_cache');
  if(c){tasks=JSON.parse(c);render();}
  loadTasks();
}
</script>
</body>
</html>
